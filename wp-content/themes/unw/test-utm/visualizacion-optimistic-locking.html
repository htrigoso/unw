<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Visualizaci√≥n: Optimistic Locking - Sistema UTM</title>
    <style>
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }

        body {
          font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          padding: 20px;
          min-height: 100vh;
        }

        .container {
          max-width: 1400px;
          margin: 0 auto;
          background: white;
          border-radius: 20px;
          padding: 30px;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
          text-align: center;
          color: #333;
          margin-bottom: 10px;
          font-size: 2.5em;
        }

        .subtitle {
          text-align: center;
          color: #666;
          margin-bottom: 30px;
          font-size: 1.1em;
        }

      .explanation {
        background: #f8f9fa;
        border-left: 4px solid #667eea;
        padding: 20px;
        margin-bottom: 30px;
        border-radius: 8px;
      }

      .explanation h3 {
        color: #667eea;
        margin-bottom: 10px;
      }

      .explanation ol {
        margin-left: 20px;
        line-height: 1.8;
      }

      .explanation code {
        background: #e9ecef;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.9em;
      }
          flex-wrap: wrap;
        }

        button {
          padding: 12px 24px;
          font-size: 16px;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          transition: all 0.3s;
          font-weight: 600;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        button:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }

        .btn-start {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
        }

        .btn-reset {
          background: #e74c3c;
          color: white;
        }

        .btn-speed {
          background: #3498db;
          color: white;
        }

        .visualization {
          background: #f8f9fa;
          border-radius: 15px;
          padding: 30px;
          margin-bottom: 30px;
          /* min-height: 500px; */
          position: relative;
          overflow: hidden;
        }

        .timeline {
          position: relative;
          height: 400px;
          margin-top: 50px;
        }

        .user {
          position: absolute;
          width: 40px;
          height: 40px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 12px;
          font-weight: bold;
          color: white;
          transition: all 0.5s ease;
          cursor: pointer;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .user.waiting {
          background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
          animation: pulse 1.5s infinite;
        }

        .user.winner {
          background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
          transform: scale(1.3);
          box-shadow: 0 0 20px rgba(79, 172, 254, 0.6);
        }

        .user.found {
          background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .user.failed {
          background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
          opacity: 0.5;
        }

        @keyframes pulse {
          0%,
          100% {
            transform: scale(1);
          }
          50% {
            transform: scale(1.1);
          }
        }

        .mysql-box {
          position: absolute;
          bottom: 50px;
          left: 50%;
          transform: translateX(-50%);
          background: linear-gradient(135deg, #ff9a56 0%, #ff6a88 100%);
          padding: 20px 40px;
          border-radius: 15px;
          color: white;
          font-weight: bold;
          font-size: 18px;
          box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
          text-align: center;
        }

        .mysql-box .lock-icon {
          font-size: 30px;
          margin-bottom: 5px;
        }

        .stats {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 20px;
          margin-top: 30px;
        }

        .stat-card {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          padding: 20px;
          border-radius: 12px;
          color: white;
          text-align: center;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
          font-size: 2.5em;
          font-weight: bold;
          margin: 10px 0;
        }

        .stat-label {
          font-size: 0.9em;
          opacity: 0.9;
        }

        .legend {
          display: flex;
          justify-content: center;
          gap: 30px;
          margin-top: 30px;
          flex-wrap: wrap;
        }

        .legend-item {
          display: flex;
          align-items: center;
          gap: 10px;
        }

        .legend-dot {
          width: 20px;
          height: 20px;
          border-radius: 50%;
        }

        .timeline-marker {
          position: absolute;
          left: 0;
          font-size: 12px;
          color: #666;
          font-family: monospace;
        }

        .log-container {
          background: #1e1e1e;
          color: #d4d4d4;
          border-radius: 10px;
          padding: 20px;
          max-height: 300px;
          overflow-y: auto;
          font-family: "Courier New", monospace;
          font-size: 13px;
          margin-top: 20px;
        }

        .log-entry {
          margin-bottom: 5px;
          padding: 5px;
          border-left: 3px solid transparent;
          padding-left: 10px;
        }

        .log-winner {
          border-left-color: #4facfe;
        }
        .log-waiting {
          border-left-color: #f5576c;
        }
        .log-found {
          border-left-color: #43e97b;
        }
        .log-error {
          border-left-color: #e74c3c;
        }
      .log-sql {
        border-left-color: #f39c12;
        background: rgba(243, 156, 18, 0.1);
        font-family: 'Courier New', monospace;
        font-size: 11px;
      }
            transform: translateX(0);
            opacity: 1;
          }
        }

        .phase-indicator {
          position: absolute;
          top: 20px;
          right: 20px;
          background: rgba(255, 255, 255, 0.9);
          padding: 15px 25px;
          border-radius: 10px;
          font-weight: bold;
          font-size: 16px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üöÄ Optimistic Locking Visualization</h1>
      <p class="subtitle">
        Sistema de prevenci√≥n de duplicados UTM con 50 usuarios simult√°neos
      </p>

      <div class="explanation">
        <h3>üí° ¬øC√≥mo obtienen el c√≥digo los usuarios 2-50?</h3>
        <ol>
          <li>
            <strong>Usuario 1 gana:</strong> Su <code>INSERT IGNORE</code> es
            exitoso ‚Üí Recibe <code>insert_id=1</code>
          </li>
          <li>
            <strong>Usuario 1 crea el post:</strong> Ejecuta
            <code>wp_insert_post()</code> ‚Üí Recibe <code>post_id=12345</code>
          </li>
          <li>
            <strong>Usuario 1 actualiza tabla:</strong>
            <code
              >UPDATE wpunw_utm_unique_temp SET post_id=12345 WHERE
              post_id=0</code
            >
          </li>
          <li>
            <strong>Usuarios 2-50 en retry loop:</strong> Cada 50-500ms
            verifican:
            <code
              >SELECT post_id FROM wpunw_utm_unique_temp WHERE utm_url='...' AND
              post_id > 0</code
            >
          </li>
          <li>
            <strong>Cuando encuentran post_id > 0:</strong> Leen el c√≥digo con
            <code>get_post_meta(12345, 'utm_code')</code> ‚Üí Obtienen "UNWP00001"
          </li>
          <li>
            <strong>Resultado:</strong> Todos reciben el mismo c√≥digo sin
            duplicados ‚úÖ
          </li>
        </ol>
      </div>

      <div class="controls">
        <button class="btn-start" onclick="startSimulation()">
          ‚ñ∂Ô∏è Iniciar Simulaci√≥n
        </button>
        <button class="btn-reset" onclick="resetSimulation()">
          üîÑ Reiniciar
        </button>
        <button class="btn-speed" onclick="toggleSpeed()">
          ‚ö° Velocidad: <span id="speed-label">Normal</span>
        </button>
      </div>

      <div class="visualization">
        <div class="phase-indicator" id="phase">Esperando inicio...</div>
        <div class="timeline" id="timeline"></div>
        <div class="mysql-box">
          <div class="lock-icon">üîí</div>
          <div>MySQL UNIQUE INDEX</div>
          <div style="font-size: 12px; margin-top: 5px">
            Serializaci√≥n Autom√°tica
          </div>
        </div>
      </div>

      <div class="stats">
        <div class="stat-card">
          <div class="stat-label">Ganadores</div>
          <div class="stat-value" id="stat-winners">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Encontrados (Retry)</div>
          <div class="stat-value" id="stat-found">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Esperando</div>
          <div class="stat-value" id="stat-waiting">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Fallidos</div>
          <div class="stat-value" id="stat-failed">0</div>
        </div>
      </div>

      <div class="legend">
        <div class="legend-item">
          <div
            class="legend-dot"
            style="
              background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            "
          ></div>
          <span>Ganador (INSERT exitoso)</span>
        </div>
        <div class="legend-item">
          <div
            class="legend-dot"
            style="
              background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            "
          ></div>
          <span>Esperando (Retry loop)</span>
        </div>
        <div class="legend-item">
          <div
            class="legend-dot"
            style="
              background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            "
          ></div>
          <span>Encontrado (C√≥digo obtenido)</span>
        </div>
        <div class="legend-item">
          <div
            class="legend-dot"
            style="
              background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            "
          ></div>
          <span>Fallido (Timeout)</span>
        </div>
      </div>

      <div class="log-container" id="logs">
        <div class="log-entry">
          üìä Sistema listo. Presiona "Iniciar Simulaci√≥n" para comenzar.
        </div>
      </div>
    </div>

    <script>
      const TOTAL_USERS = 50;
      let users = [];
      let speed = 1; // 1 = normal, 2 = fast, 3 = very fast
      let isRunning = false;
      let stats = {
        winners: 0,
        found: 0,
        waiting: 0,
        failed: 0,
      };

      function toggleSpeed() {
        speed = speed === 3 ? 1 : speed + 1;
        const labels = ["Normal", "R√°pido", "Muy R√°pido"];
        document.getElementById("speed-label").textContent = labels[speed - 1];
      }

      function getDelay(ms) {
        return ms / speed;
      }

      function addLog(message, type = "") {
        const logsContainer = document.getElementById("logs");
        const timestamp = new Date().toLocaleTimeString("es-PE", {
          hour12: false,
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
          fractionalSecondDigits: 3,
        });

        const logEntry = document.createElement("div");
        logEntry.className = `log-entry ${type}`;
        logEntry.innerHTML = `<span class="timestamp">${timestamp}</span>${message}`;
        logsContainer.appendChild(logEntry);
        logsContainer.scrollTop = logsContainer.scrollHeight;
      }

      function updateStats() {
        document.getElementById("stat-winners").textContent = stats.winners;
        document.getElementById("stat-found").textContent = stats.found;
        document.getElementById("stat-waiting").textContent = stats.waiting;
        document.getElementById("stat-failed").textContent = stats.failed;
      }

      function updatePhase(phase) {
        document.getElementById("phase").textContent = phase;
      }

      function createUser(id) {
        const timeline = document.getElementById("timeline");
        const user = document.createElement("div");
        user.className = "user waiting";
        user.textContent = id;
        user.id = `user-${id}`;
        user.style.left = "20px";
        user.style.top = `${20 + (id % 8) * 50}px`;
        user.title = `Usuario ${id}`;
        timeline.appendChild(user);
        return user;
      }

      async function animateUser(user, endX, className) {
        return new Promise((resolve) => {
          user.style.left = `${endX}px`;
          user.className = `user ${className}`;
          setTimeout(resolve, getDelay(500));
        });
      }

      async function startSimulation() {
        if (isRunning) return;
        isRunning = true;

        resetSimulation();

        addLog(
          "üöÄ Iniciando simulaci√≥n con 50 usuarios simult√°neos...",
          "log-winner"
        );
        updatePhase("Fase 1: Usuarios llegando...");

        await new Promise((resolve) => setTimeout(resolve, getDelay(1000)));

        // FASE 1: Crear todos los usuarios
        addLog(
          `üìç 50 usuarios ejecutan INSERT IGNORE simult√°neamente`,
          "log-waiting"
        );
        stats.waiting = TOTAL_USERS;
        updateStats();

        for (let i = 1; i <= TOTAL_USERS; i++) {
          const user = createUser(i);
          users.push({ id: i, element: user, status: "waiting" });
          await new Promise((resolve) => setTimeout(resolve, getDelay(30)));
        }

        await new Promise((resolve) => setTimeout(resolve, getDelay(1000)));

        // FASE 2: Usuario 1 gana
        updatePhase("Fase 2: UNIQUE INDEX serializa...");
        addLog(`üîí MySQL UNIQUE INDEX detecta colisi√≥n`, "log-winner");
        await new Promise((resolve) => setTimeout(resolve, getDelay(500)));

        const winner = users[0];
        addLog(
          `‚úÖ Usuario 1: INSERT exitoso ‚Üí insert_id=1 (GANADOR)`,
          "log-winner"
        );
        await animateUser(winner.element, 600, "winner");
        winner.status = "winner";
        stats.winners = 1;
        stats.waiting = TOTAL_USERS - 1;
        updateStats();

        await new Promise((resolve) => setTimeout(resolve, getDelay(800)));

        // FASE 3: Resto de usuarios en retry loop
        updatePhase("Fase 3: Retry loop activo...");
        addLog(`‚ùå Usuarios 2-50: INSERT fall√≥ ‚Üí insert_id=0`, "log-waiting");
        addLog(`‚è≥ Usuarios 2-50 entran en retry loop...`, "log-waiting");
        addLog(
          `   SQL: SELECT post_id FROM wpunw_utm_unique_temp WHERE utm_url='...' AND post_id > 0`,
          "log-sql"
        );
        addLog(`   Resultado: NULL (Usuario 1 a√∫n no termin√≥)`, "log-sql");

        // Winner crea post
        await new Promise((resolve) => setTimeout(resolve, getDelay(1000)));
        addLog(`üíæ Usuario 1 crea wp_post (ID: 12345)`, "log-winner");
        addLog(
          `   SQL: INSERT INTO wp_posts (post_title, ...) VALUES ('UNWP00001 - ...', ...)`,
          "log-sql"
        );

        await new Promise((resolve) => setTimeout(resolve, getDelay(500)));
        addLog(
          `üîÑ Usuario 1 actualiza post_id en tabla auxiliar`,
          "log-winner"
        );
        addLog(
          `   SQL: UPDATE wpunw_utm_unique_temp SET post_id=12345 WHERE post_id=0 AND utm_url='...'`,
          "log-sql"
        );
        addLog(
          `   ‚úÖ Ahora los otros usuarios PUEDEN leer el c√≥digo`,
          "log-winner"
        );

        // Simulate retry loops
        updatePhase("Fase 4: Usuarios encontrando c√≥digo...");

        // Retry 1 (50ms) - 60% encuentra
        await new Promise((resolve) => setTimeout(resolve, getDelay(300)));
        const retry1Count = Math.floor(TOTAL_USERS * 0.6);
        addLog(
          `üîç Retry #1 (50ms): ${retry1Count} usuarios encuentran post_id`,
          "log-found"
        );
        addLog(
          `   SQL: SELECT post_id FROM wpunw_utm_unique_temp WHERE ... ‚Üí post_id=12345`,
          "log-sql"
        );
        addLog(
          `   SQL: SELECT meta_value FROM wp_postmeta WHERE post_id=12345 AND meta_key='utm_code' ‚Üí 'UNWP00001'`,
          "log-sql"
        );

        for (let i = 1; i < retry1Count; i++) {
          if (users[i].status === "waiting") {
            animateUser(users[i].element, 1100, "found");
            users[i].status = "found";
            stats.found++;
            stats.waiting--;
          }
          await new Promise((resolve) => setTimeout(resolve, getDelay(20)));
        }
        updateStats();

        // Retry 2 (100ms) - 25% encuentra
        await new Promise((resolve) => setTimeout(resolve, getDelay(500)));
        const retry2Count = Math.floor(TOTAL_USERS * 0.85);
        addLog(
          `üîç Retry #2 (100ms): ${
            retry2Count - retry1Count
          } usuarios leen c√≥digo 'UNWP00001'`,
          "log-found"
        );

        for (let i = retry1Count; i < retry2Count; i++) {
          if (users[i].status === "waiting") {
            animateUser(users[i].element, 1100, "found");
            users[i].status = "found";
            stats.found++;
            stats.waiting--;
          }
          await new Promise((resolve) => setTimeout(resolve, getDelay(20)));
        }
        updateStats();

        // Retry 3 (200ms) - 10% encuentra
        await new Promise((resolve) => setTimeout(resolve, getDelay(700)));
        const retry3Count = Math.floor(TOTAL_USERS * 0.95);
        addLog(
          `üîç Retry #3 (200ms): ${
            retry3Count - retry2Count
          } usuarios leen c√≥digo 'UNWP00001'`,
          "log-found"
        );

        for (let i = retry2Count; i < retry3Count; i++) {
          if (users[i].status === "waiting") {
            animateUser(users[i].element, 1100, "found");
            users[i].status = "found";
            stats.found++;
            stats.waiting--;
          }
          await new Promise((resolve) => setTimeout(resolve, getDelay(20)));
        }
        updateStats();

        // √öltimos usuarios
        await new Promise((resolve) => setTimeout(resolve, getDelay(1000)));
        const remaining = TOTAL_USERS - retry3Count;
        if (remaining > 0) {
          addLog(
            `üîç Retry #4-10: ${remaining - 1} usuarios leen c√≥digo 'UNWP00001'`,
            "log-found"
          );

          for (let i = retry3Count; i < TOTAL_USERS - 1; i++) {
            if (users[i].status === "waiting") {
              animateUser(users[i].element, 1100, "found");
              users[i].status = "found";
              stats.found++;
              stats.waiting--;
            }
            await new Promise((resolve) => setTimeout(resolve, getDelay(30)));
          }
          updateStats();

          // 1 usuario falla (0.01%)
          await new Promise((resolve) => setTimeout(resolve, getDelay(1000)));
          const lastUser = users[TOTAL_USERS - 1];
          if (lastUser.status === "waiting") {
            addLog(
              `‚ùå Usuario ${TOTAL_USERS}: Timeout despu√©s de 10 reintentos`,
              "log-error"
            );
            animateUser(lastUser.element, 1100, "failed");
            lastUser.status = "failed";
            stats.failed = 1;
            stats.waiting = 0;
            updateStats();
          }
        }

        // FINALIZAR
        await new Promise((resolve) => setTimeout(resolve, getDelay(1000)));
        updatePhase("‚úÖ Simulaci√≥n completada");
        addLog(``, "");
        addLog(`üìä RESULTADOS FINALES:`, "log-winner");
        addLog(
          `   ‚úÖ ${stats.winners} ganador (cre√≥ el c√≥digo 'UNWP00001')`,
          "log-winner"
        );
        addLog(
          `   ‚úÖ ${stats.found} leyeron el MISMO c√≥digo 'UNWP00001' (sin duplicados)`,
          "log-found"
        );
        addLog(
          `   ‚ùå ${stats.failed} fallaron (timeout despu√©s de 10 reintentos)`,
          "log-error"
        );
        addLog(
          `   üéØ Tasa de √©xito: ${(
            ((stats.winners + stats.found) / TOTAL_USERS) *
            100
          ).toFixed(2)}%`,
          "log-winner"
        );
        addLog(``, "");
        addLog(
          `   üîê CLAVE: Todos obtuvieron el MISMO c√≥digo sin duplicados`,
          "log-winner"
        );
        addLog(
          `   üéØ Usuario 1 cre√≥ ‚Üí Usuarios 2-50 esperaron y leyeron`,
          "log-winner"
        );

        isRunning = false;
      }

      function resetSimulation() {
        const timeline = document.getElementById("timeline");
        timeline.innerHTML = "";

        users = [];
        stats = {
          winners: 0,
          found: 0,
          waiting: 0,
          failed: 0,
        };
        updateStats();
        updatePhase("Esperando inicio...");

        document.getElementById("logs").innerHTML =
          '<div class="log-entry">üìä Sistema reiniciado. Presiona "Iniciar Simulaci√≥n".</div>';

        isRunning = false;
      }

      // Auto-start on load (optional)
      // window.onload = () => setTimeout(startSimulation, 1000);
    </script>
  </body>
</html>
